<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">

    <!-- Optional theme -->
    <link rel="stylesheet" href="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap-theme.min.css">

    <link rel="stylesheet" href="styles/main.css">

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>

    <!-- Latest compiled and minified JavaScript -->
    <script src="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/typeahead.js/0.10.2/typeahead.bundle.min.js"></script>
  </head>

  <script type="text/javascript">
    var modifyViewModal = function() {
      var ps_name = document.getElementById('program-sheet-search-box').value;
      document.getElementById("viewModalLabel").innerHTML = ps_name;
      var xhr = new XMLHttpRequest();
      xhr.onreadystatechange = function() {
        if (xhr.readyState == 4) {
          var json_str = "Program Sheet does not exist!";
          if (xhr.status === 200) {
            json_str = xhr.responseText;
          }
          $("textarea#viewTextAreaID").val(json_str);
        }
      }
      xhr.open("GET", "/api/programsheet?ps_name=" + ps_name, true);
      xhr.send();
    }

    var modifyCreateModal = function() {
      var ps_name = document.getElementById('program-sheet-search-box').value;
      document.getElementById("createModalLabel").innerHTML = ps_name;
      var json_str = '{\n' +
                     '\"ps_name\":' + '\"' + ps_name + '\",\n' +
                     '\"req_boxes\":[]\n' +
                     '}';
      $("textarea#createTextAreaID").val(json_str);
    }

    var modifyDeleteModal = function() {
      var ps_name = document.getElementById('program-sheet-search-box').value;
      document.getElementById("deleteModalLabel").innerHTML = ps_name;
    }

    var isValidJson = function(json) {
        try {
            JSON.parse(json);
            return true;
        } catch (e) {
            return false;
        }
    }

    var createProgramSheet = function() {
      ps_name = document.getElementById("createModalLabel").innerHTML;
      var ps_json_str = document.getElementById('createTextAreaID').value;
      if (!isValidJson(ps_json_str)) {
        window.alert("Invalid JSON");
        return;
      }
      var xhr = new XMLHttpRequest();
      xhr.onreadystatechange = function() {
        if (xhr.readyState == 4) {
          var json_str = xhr.responseText;
          json = JSON.parse(json_str);
          ps_exists = json.exists;
          if (ps_exists) {
            window.alert("Program Sheet already exists!");
            return;
          }
          var send_xhr = new XMLHttpRequest();
          send_xhr.onreadystatechange = function() {
            if (send_xhr.readyState === 4) {
              if (send_xhr.status === 200) {
                window.alert("Success!");
                return;
              }
              else {
                window.alert("Failed to Add Program Sheet :(");
              }
            }
          }
          send_xhr.open("POST", "/api/programsheet", true);
          var params = "ps_json=" + ps_json_str;
          send_xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
          send_xhr.send(params)
        }
      }
      xhr.open("PUT", "/api/programsheet", true);
      var params = "ps_name=" + ps_name;
      //Send the proper header information along with the request
      xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
      xhr.send(params);
    }

    var deleteProgramSheet = function() {
      ps_name = document.getElementById("deleteModalLabel").innerHTML;
      var xhr = new XMLHttpRequest();
      xhr.onreadystatechange = function() {
        if (xhr.readyState == 4) {
          if (xhr.status === 200) {
            window.alert("Successfully deleted!");
            return;
          }
          else {
            window.alert("Failed to delete Program Sheet :(");
          }
        }
      }
      xhr.open("DELETE", "/api/programsheet?ps_name=" + ps_name, true);
      xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
      xhr.send() 
    }
  </script>


  <body>
    <div class="container-fluid">
      <div class="box">
        <div class="row header-row">
          <div id="header">
            <ul class="nav nav-pills pull-right nav-container">
            </ul>
            <h3 class="logo">CoursePlanner Admin</h3>
          </div>
        </div>
      </div>
    </div>

    <div id="program-sheet" style="position:absolute;left:30px;top:70px">
      <input id="program-sheet-search-box" class="typeahead" type="text" placeholder="Input Program Sheet">
      <button class="btn btn-primary" data-toggle="modal" data-target="#viewModal" onclick="modifyViewModal()">
        View
      </button>
      <button class="btn btn-primary" data-toggle="modal" data-target="#createModal" onclick="modifyCreateModal()">
        Create
      </button>
      <button class="btn btn-primary" data-toggle="modal" data-target="#deleteModal" onclick="modifyDeleteModal()">
        Delete
      </button>
    </div>

    <script type="text/javascript">
      $(document).ready(function() {
        var substringMatcher = function() {
          return function findMatches(q, cb) {
            var strs = [];
            var xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function() {
                if (xhr.readyState == 4) {
                  if (xhr.status === 200) {
                    var json_str = xhr.responseText;
                    strs = jQuery.parseJSON(json_str);
                  }
                  var matches, substringRegex;
               
                  // an array that will be populated with substring matches
                  matches = [];
               
                  // regex used to determine if a string contains the substring `q`
                  substrRegex = new RegExp(q, 'i');
               
                  // iterate through the pool of strings and for any string that
                  // contains the substring `q`, add it to the `matches` array
                  $.each(strs, function(i, str) {
                    if (substrRegex.test(str)) {
                      // the typeahead jQuery plugin expects suggestions to a
                      // JavaScript object, refer to typeahead docs for more info
                      matches.push({ value: str });
                    }
                  });
                  console.log(matches)
                  cb(matches);
                }
            }
            xhr.open("GET", "/api/programsheet/search?ps_name_prefix=" + q, true);
            xhr.send();
          };
        };
           
        $('#program-sheet .typeahead').typeahead({
          hint: true,
          highlight: true,
          minLength: 1
        },
        {
          name: 'program-sheet',
          displayKey: 'value',
          source: substringMatcher()
        });
      });
    </script>

    <div class="modal fade" id="viewModal" tabindex="-1" role="dialog" aria-labelledby="viewModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
            <h4 class="modal-title" id="viewModalLabel">Place Holder</h4>
          </div>
          <div id="view-modal-body" class="modal-body">
            <textarea id="viewTextAreaID" rows="20" cols="80">Please wait while we fetch the json string...!</textarea>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="createModal" tabindex="-1" role="dialog" aria-labelledby="createModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
            <h4 class="modal-title" id="createModalLabel"> Place Holder </h4>
          </div>
          <div class="modal-body">
            <textarea id="createTextAreaID" rows="20" cols="80"></textarea>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary" onclick="createProgramSheet()">Create</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="deleteModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
            <h4 class="modal-title" id="deleteModalLabel">Modal title</h4>
          </div>
          <div class="modal-body">
            Are you sure you want to delete this program sheet?
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary" onclick="deleteProgramSheet()">Delete</button>
          </div>
        </div>
      </div>
    </div>


  </body>
</html>